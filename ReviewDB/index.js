(function(p,a,t,o,I,c,w,T,S,d,N,R,B){"use strict";const D="915703782174752809",h="https://manti.vendicated.dev";async function k(e){return await(await c.safeFetch(h+"/getUserReviews?discordid="+e,{})).json()}async function U(){return await(await c.safeFetch(h+"/admins",{})).json()}async function F(e,n){return await(await c.safeFetch(h+"/addUserReview",{method:"POST",body:JSON.stringify({userid:e,comment:n,token:a.storage.authToken}),headers:{"content-type":"application/json",accept:"text/plain"}})).text()}async function L(e){return await(await c.safeFetch(h+"/deleteReview",{method:"POST",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify({reviewid:e,token:a.storage.authToken})})).json()}async function _(e){return await(await c.safeFetch(h+"/reportReview",{method:"POST",headers:{"content-type":"application/json",accept:"text/plain"},body:JSON.stringify({reviewid:e,token:a.storage.authToken})})).text()}const{getCurrentUser:b}=o.findByStoreName("UserStore"),$=function(e){return e.senderdiscordid===b()?.id||m.includes(b()?.id)};t.stylesheet.createThemedStyleSheet({icon:{height:16,width:16,borderRadius:8}});const{hideActionSheet:O}=o.findByProps("openLazy","hideActionSheet"),{showSimpleActionSheet:j}=o.findByProps("showSimpleActionSheet"),M=function(e){return j({key:"ReviewOverflow",header:{title:`Review by ${e.username}`,onClose:function(){return O()}},options:[{label:"Copy Text",onPress:function(){t.clipboard.setString(e.comment),R.showToast("Copied Review Text",d.getAssetIDByName("ic_message_copy"))}},...a.storage.authToken?[...$(e)?[{label:"Delete Review",isDestructive:!0,onPress:function(){return T.showConfirmationAlert({title:"Delete Review",content:"Are you sure you want to delete this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return L(e.id)}})}}]:[],{label:"Report Review",isDestructive:!0,onPress:function(){return T.showConfirmationAlert({title:"Report Review",content:"Are you sure you want to report this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return _(e.id)}})}}]:[]]})},z=t.stylesheet.createThemedStyleSheet({avatar:{height:36,width:36,borderRadius:18}}),{FormRow:V,FormLabel:Y,FormSubLabel:J}=w.Forms,{colors:X,meta:H}=o.findByProps("colors","meta"),G=o.findByProps("useThemeContext").useThemeContext;function K(e){let{review:n}=e;const r=G(),s=H.resolveSemanticColor(r.theme,X.TEXT_NORMAL);return React.createElement(V,{label:React.createElement(Y,{text:n.username,style:{color:s}}),subLabel:React.createElement(J,{text:n.comment,style:{color:s}}),leading:React.createElement(t.ReactNative.Image,{style:z.avatar,source:{uri:n.profile_photo}}),onLongPress:function(){return M(n)}})}const v=t.stylesheet.createThemedStyleSheet({container:{flex:1,flexDirection:"row",alignItems:"center",justifyContent:"center",marginHorizontal:4},textInput:{flex:1,flexGrow:1,fontSize:16,fontFamily:t.constants.Fonts.DISPLAY_MEDIUM},sendButton:{flexShrink:0,flexDirection:"row",alignItems:"center",justifyContent:"center",backgroundColor:B.rawColors.BRAND_500,height:40,width:40,borderRadius:20,marginLeft:4}}),{colors:A,meta:E}=o.findByProps("colors","meta"),q=o.findByProps("useThemeContext").useThemeContext;function Q(e){let{userId:n,shouldEdit:r,refetch:s}=e;S.useProxy(a.storage);const i=q(),l=E.resolveSemanticColor(i.theme,A.TEXT_NORMAL),u=E.resolveSemanticColor(i.theme,A.INPUT_PLACEHOLDER_TEXT),[g,C]=t.React.useState(""),P=!a.storage.authToken,x=!a.storage.authToken||g.length===0;return t.React.createElement(t.ReactNative.View,{style:v.container},t.React.createElement(t.ReactNative.TextInput,{style:{...v.textInput,color:l},editable:!P,placeholder:P?"You must be authenticated to add a review.":`Tap to ${r?"edit your":"add a"} review`,placeholderTextColor:u,value:g,onChangeText:function(y){return C(y)}}),t.React.createElement(t.ReactNative.Pressable,{style:{...v.sendButton,opacity:x?.25:1},disabled:x,onPress:function(){F(n,g).then(function(y){C(""),s(),R.showToast(y,d.getAssetIDByName("Check"))}).catch(function(y){return R.showToast(y,d.getAssetIDByName("Small"))})}},t.React.createElement(t.ReactNative.Image,{style:{tintColor:"#fff"},source:d.getAssetIDByName("ic_send")})))}const{getCurrentUser:W}=o.findByStoreName("UserStore"),Z=o.findByDisplayName("UserProfileSection");function ee(e){let{userId:n}=e;const[r,s]=t.React.useState([]),i=function(){k(n).then(function(u){return s(u)})};t.React.useEffect(i,[]);const l=r.filter(function(u){return u.senderdiscordid===W()?.id}).length!==0;return t.React.createElement(w.ErrorBoundary,null,t.React.createElement(Z,{title:"Reviews",showContainer:!0},t.React.createElement(t.ReactNative.View,{style:{flex:1}},r.map(function(u){return t.React.createElement(K,{review:u})})),t.React.createElement(Q,{userId:n,refetch:i,shouldEdit:l})))}const te=o.find(function(e){return e.type?.name==="UserProfile"}),ne=function(){return I.after("type",te,function(e,n){const r=c.findInReactTree(n,function(i){return i?.props?.children.find(function(l){return typeof l?.props?.displayProfile?.userId=="string"})&&i?.type?.displayName==="View"&&Array?.isArray(i?.props?.style)})?.props?.children,s=e[0].userId;r?.push(t.React.createElement(ee,{userId:s}))})},{pushModal:re,popModal:ae}=o.findByProps("pushModal"),oe=o.findByDisplayName("OAuth2AuthorizeModal");function ie(){return re({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:oe,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:D,redirectUri:h+"/URauth",scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(e){let{location:n}=e;try{const r=new URL(n);r.searchParams.append("returnType","json"),r.searchParams.append("clientMod","vendetta");const s=await c.safeFetch(r.toString(),{headers:{accept:"application/json"}}),{token:i,status:l}=await s.json();if(l===0)a.storage.authToken=i;else throw new Error("Status returned by backend was not OK")}catch(r){N.logger.error("Authorization failed!",r)}},dismissOAuthModal:function(){return ae("oauth2-authorize")}},closable:!0}})}const{FormSection:se,FormRow:f}=w.Forms;function ce(){return S.useProxy(a.storage),React.createElement(t.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},React.createElement(se,{title:"Authentication",titleStyleType:"no_border"},React.createElement(f,{label:"Authenticate with ReviewDB",leading:React.createElement(f.Icon,{source:d.getAssetIDByName("copy")}),trailing:f.Arrow,onPress:ie}),React.createElement(f,{label:"Log out of ReviewDB",subLabel:"Note that this does not remove ReviewDB from your Authorized Apps page in Discord.",leading:React.createElement(f.Icon,{source:d.getAssetIDByName("ic_logout_24px")}),disabled:a.storage.authToken.length===0,onPress:function(){return a.storage.authToken=""}})))}a.storage.authToken??="";const le=[ne()],m=[];U().then(function(e){return m.push(...e)});const ue=function(){return le.forEach(function(e){return e()})};return p.admins=m,p.onUnload=ue,p.settings=ce,p})({},vendetta.plugin,vendetta.metro.common,vendetta.metro,vendetta.patcher,vendetta.utils,vendetta.ui.components,vendetta.ui.alerts,vendetta.storage,vendetta.ui.assets,vendetta,vendetta.ui.toasts,vendetta.ui);
